# /mineru_stack/nginx.conf

# 定义工作进程数和连接数
events {
    worker_connections 1024;
}

http {
    # 定义上游服务器集群，NGINX将在这里进行负载均衡
    # 默认的负载均衡策略就是 round-robin (轮询)，无需额外指定
    upstream mineru_backend {
        # 使用 docker-compose 定义的服务名进行通信
        # Docker 内置的 DNS 会将服务名解析到正确的容器 IP
        server mineru-api-1:8000;
        server mineru-api-2:8000;
    }

    server {
        # NGINX 容器监听 80 端口
        listen 80;

        # 设置允许的客户端请求体大小，例如 150MB
        client_max_body_size 150M;

        location / {
            # 设置代理超时时间为 60 分钟
            proxy_connect_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;
            send_timeout 3600s;

            # 将请求转发到我们定义的上游服务器集群
            proxy_pass http://mineru_backend;

            # 设置一些必要的头信息，以便后端服务能获取到真实的客户端信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}